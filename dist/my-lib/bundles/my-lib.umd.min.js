!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("@angular/core"),require("leaflet"),require("rxjs"),require("rxjs/operators"),require("@turf/turf"),require("concaveman")):"function"==typeof define&&define.amd?define("my-lib",["exports","@angular/core","leaflet","rxjs","rxjs/operators","@turf/turf","concaveman"],o):o((t=t||self)["my-lib"]={},t.ng.core,t.leaflet,t.rxjs,t.rxjs.operators,t.turf,t.concaveman)}(this,(function(t,o,e,n,r,a,i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;var s=function(){return(s=Object.assign||function(t){for(var o,e=1,n=arguments.length;e<n;e++)for(var r in o=arguments[e])Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r]);return t}).apply(this,arguments)};function l(t,o,e,n){var r,a=arguments.length,i=a<3?o:null===n?n=Object.getOwnPropertyDescriptor(o,e):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,o,e,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(i=(a<3?r(i):a>3?r(o,e,i):r(o,e))||i);return a>3&&i&&Object.defineProperty(o,e,i),i}function u(t,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,o)}function c(t,o){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,r,a=e.call(t),i=[];try{for(;(void 0===o||o-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(t){r={error:t}}finally{try{n&&!n.done&&(e=a.return)&&e.call(a)}finally{if(r)throw r.error}}return i}function g(){for(var t=[],o=0;o<arguments.length;o++)t=t.concat(c(arguments[o]));return t}var p,f,h=function(){function t(){this.mapSubject=new n.BehaviorSubject(null),this.map$=this.mapSubject.asObservable(),this.polygonSubject=new n.BehaviorSubject(null),this.polygons$=this.polygonSubject.asObservable()}return t.prototype.updateMapState=function(t){this.mapSubject.next(t)},t.prototype.updatePolygons=function(t){console.log("map-state",t),this.polygonSubject.next(t)},t.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}();!function(t){t[t.Off=0]="Off",t[t.Add=1]="Add",t[t.Edit=2]="Edit",t[t.Subtract=4]="Subtract",t[t.AppendMarker=8]="AppendMarker",t[t.LoadPredefined=16]="LoadPredefined"}(p||(p={})),function(t){t[t.North=1]="North",t[t.East=2]="East",t[t.South=3]="South",t[t.West=4]="West",t[t.NorthEast=5]="NorthEast",t[t.NorthWest=6]="NorthWest",t[t.SouthEast=7]="SouthEast",t[t.SouthWest=8]="SouthWest"}(f||(f={}));var y=function(){function t(){}return t.getBounds=function(t,o){void 0===o&&(o=0);var n=[];t.forEach((function(t){isNaN(t.lat)||isNaN(t.lng),n.push(t)}));var r=new e.Polyline(n).getBounds();return 0!==o?r.pad(o):r},t}(),d=function(){function t(t,o,e,n){void 0===t&&(t=0),void 0===o&&(o=0),void 0===e&&(e=0),void 0===n&&(n=0),this.direction={East:{lat:0,lng:0},North:{lat:0,lng:0},NorthEast:{lat:0,lng:0},NorthWest:{lat:0,lng:0},South:{lat:0,lng:0},SouthEast:{lat:0,lng:0},SouthWest:{lat:0,lng:0},West:{lat:0,lng:0}},this.direction.North={lat:e,lng:(o+n)/2},this.direction.NorthEast={lat:e,lng:n},this.direction.East={lat:(t+e)/2,lng:n},this.direction.SouthEast={lat:t,lng:n},this.direction.South={lat:t,lng:(o+n)/2},this.direction.SouthWest={lat:t,lng:o},this.direction.West={lat:(t+e)/2,lng:o},this.direction.NorthWest={lat:e,lng:o}}return t.prototype.getDirection=function(t){switch(t){case f.North:return this.direction.North;case f.NorthEast:return this.direction.NorthEast;case f.East:return this.direction.East;case f.SouthEast:return this.direction.SouthEast;case f.South:return this.direction.South;case f.SouthWest:return this.direction.SouthWest;case f.West:return this.direction.West;case f.NorthWest:return this.direction.NorthWest;default:return this.direction.North}},t}(),m=function(){function t(){this.simplifyTolerance={tolerance:1e-4,highQuality:!1}}return t.prototype.union=function(t,o){console.log("poly1: ",t),console.log("poly2: ",o);var e=a.union(t,o);return this.getTurfPolygon(e)},t.prototype.turfConcaveman=function(t){var o=a.explode(t).features.map((function(t){return t.geometry.coordinates}));return a.multiPolygon([[i(o)]])},t.prototype.getSimplified=function(t){var o=this.simplifyTolerance;return a.simplify(t,o)},t.prototype.getTurfPolygon=function(t){return console.log("Get TurfPolygon:",t),"Polygon"===t.geometry.type?a.multiPolygon([t.geometry.coordinates]):a.multiPolygon(t.geometry.coordinates)},t.prototype.getMultiPolygon=function(t){return a.multiPolygon(t)},t.prototype.getKinks=function(t){var o=a.unkinkPolygon(t),e=[];return a.featureEach(o,(function(t){e.push(t)})),e},t.prototype.getCoords=function(t){return a.getCoords(t)},t.prototype.hasKinks=function(t){return a.kinks(t).features.length>0},t.prototype.polygonIntersect=function(t,o){var e=[],n=[];console.log("polygonIntersect",t,o),a.getCoords(o).forEach((function(t){var o={type:"Polygon",coordinates:[t[0]]};e.push(o)})),a.getCoords(t).forEach((function(t){var o={type:"Polygon",coordinates:[t[0]]};n.push(o)}));var r=!1;t:for(var i=0;i<e.length;i++)if(this.getKinks(e[i]).length<2)for(var s=0;s<n.length;s++)if(this.getKinks(n[s]).length<2&&(r=!!a.intersect(e[i],n[s])))break t;return r},t.prototype.getIntersection=function(t,o){return a.intersect(t,o)},t.prototype.getDistance=function(t,o){return a.distance(t,o)},t.prototype.isWithin=function(t,o){return console.log(t),console.log("Ytre: ",o),a.booleanWithin(a.polygon([t]),a.polygon([o]))},t.prototype.equalPolygons=function(t,o){console.log(t),console.log(o),console.log(a.booleanEqual(t,o))},t.prototype.convertToBoundingBoxPolygon=function(t){var o=a.bbox(t.geometry);return a.bboxPolygon(o)},t.prototype.polygonToMultiPolygon=function(t){return a.multiPolygon([t.geometry.coordinates])},t.prototype.injectPointToPolygon=function(t,o){var e,n=a.getCoords(t);if(console.log("polygon: ",t),n.length<2){var r=a.explode(t);console.log(a.nearestPoint(o,r));var i=a.nearestPoint(o,r).properties.featureIndex,s=a.coordReduce(r,(function(t,e,n){return g(t,i===n?[e,o]:[e])}),[]);console.log("test",s),e=a.multiPolygon([[s]])}else{var l=[],u=[];n.forEach((function(t){var e=a.polygon(t);if(a.booleanPointInPolygon(o,e)){var n=a.explode(e),r=a.nearestPoint(o,n).properties.featureIndex;u=a.coordReduce(n,(function(t,e,n){return g(t,r===n?[e,o]:[e])}),[]),console.log("coordinates",u)}else l.push(t)})),l.push([u]),e=a.multiPolygon(l)}return e},t.prototype.polygonDifference=function(t,o){var e=a.difference(t,o);return console.log(e),this.getTurfPolygon(e)},t.prototype.getBoundingBoxCompassPosition=function(t,o,e,n){this.getMultiPolygon(t);var r=this.getBoundingBoxCompass(t),i=a.explode(t),s=this.getCoord(r.direction.North);a.nearestPoint(s,i);return null},t.prototype.getBoundingBoxCompass=function(t){var o=this.getMultiPolygon(t),e=(a.centerOfMass(o),a.bbox(o)),n=e[0],r=e[1],i=e[2],s=e[3];return new d(n,r,i,s)},t.prototype.getNearestPointIndex=function(t,o){return a.nearestPoint(t,o).properties.featureIndex},t.prototype.getCoord=function(t){return a.getCoord([t.lng,t.lat])},t.prototype.getFeaturePointCollection=function(t){var o=[];return t.forEach((function(t){var e=a.point([t.lng,t.lat],{});o.push(e)})),a.featureCollection(o)},t.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),v=function(){function t(){}return t.getCenter=function(t){var o=Math.PI,e=0,n=0,r=0;t.forEach((function(t){var a=t.lat,i=t.lng;a=a*o/180,i=i*o/180,e+=Math.cos(a)*Math.cos(i),n+=Math.cos(a)*Math.sin(i),r+=Math.sin(a)}));var a=Math.atan2(n,e),i=Math.sqrt(e*e+n*n),s=Math.atan2(r,i);return{lat:s=180*s/o,lng:a=180*a/o}},t.getSouthWest=function(t){return this.getBounds(t).getNorthWest()},t.getNorthEast=function(t){return this.getBounds(t).getNorthEast()},t.getNorthWest=function(t){return this.getBounds(t).getNorthWest()},t.getSouthEast=function(t){return this.getBounds(t).getSouthEast()},t.getNorth=function(t){return this.getBounds(t).getNorth()},t.getSouth=function(t){return this.getBounds(t).getSouth()},t.getWest=function(t){return this.getBounds(t).getWest()},t.getEast=function(t){return this.getBounds(t).getEast()},t.getSqmArea=function(t){var o=new e.Polygon(t).toGeoJSON();return a.area(o)},t.getPerimeter=function(t){var o=new e.Polygon(t).toGeoJSON();return a.length(o,{units:"meters"})},t.getPolygonChecksum=function(t){var o=t.filter((function(t,o,e){return e.indexOf(e.find((function(o){return o.lat===t.lat&&o.lng===t.lng})))===o}));return o.reduce((function(t,o){return+t+ +o.lat}),0)*o.reduce((function(t,o){return+t+ +o.lng}),0)},t.getMidPoint=function(t,o){var e=a.point([t.lng,t.lat]),n=a.point([o.lng,o.lat]),r=a.midpoint(e,n);return{lat:r.geometry.coordinates[1],lng:r.geometry.coordinates[0]}},t.getBounds=function(t){var o=[];return t.forEach((function(t){isNaN(t.lat)||isNaN(t.lng),o.push(t)})),new e.Polyline(o).getBounds()},t}(),P=function(){function t(t){var o=this;this.polygon=[],this.trashcanPoint=[],this.sqmArea=[],this.perimeter=[],console.log("PolygonInfo: ",t),t.forEach((function(t,e){o.trashcanPoint[e]=o.getTrashcanPoint(t[0]),o.sqmArea[e]=o.calculatePolygonArea(t[0]),o.perimeter[e]=o.calculatePolygonPerimeter(t[0]),console.log(t[0]),o.polygon[e]=t}))}return t.prototype.setSqmArea=function(t){this.sqmArea[0]=t},t.prototype.getTrashcanPoint=function(t){var o,e,n=Math.max.apply(Math,t.map((function(t){return t.lat}))),r=t.findIndex((function(t){return t.lat===n}));r>0?(o=t[r-1],e=r<t.length-1?t[r+1]:t[0]):(o=t[t.length-1],e=t[r+1]);var a=o.lng<e.lng?o:e;return v.getMidPoint(t[r],a)},t.prototype.calculatePolygonArea=function(t){return v.getSqmArea(t)},t.prototype.calculatePolygonPerimeter=function(t){return v.getPerimeter(t)},t}(),S=(function(){function t(){this.canUsePolyDraw=!1,this.reset()}t.prototype.activate=function(){this.reset(),this.isActivated=!0},t.prototype.reset=function(){this.isActivated=!1,this.hasPolygons=!1,this.canRevert=!1,this.isAuto=!1,this.resetDrawModes()},t.prototype.resetDrawModes=function(){this.isFreeDrawMode=!1,this.isMoveMode=!1},t.prototype.setFreeDrawMode=function(t){void 0===t&&(t=!1),t&&(this.isActivated=!0),this.isActivated&&(this.resetDrawModes(),this.isFreeDrawMode=!0,t&&(this.isAuto=!0))},t.prototype.setMoveMode=function(){this.isActivated&&(this.resetDrawModes(),this.isMoveMode=!0)},t.prototype.forceCanUseFreeDraw=function(){this.canUsePolyDraw=!0}}(),function(){function t(t){this.mapStateService=t,this.polygonInformationSubject=new n.Subject,this.polygonInformation$=this.polygonInformationSubject.asObservable(),this.polygonDrawStatesSubject=new n.Subject,this.polygonDrawStates$=this.polygonDrawStatesSubject.asObservable(),this.polygonInformationStorage=[]}return t.prototype.updatePolygons=function(){console.log("updatePolygons: ",this.polygonInformationStorage);var t=null;this.polygonInformationStorage.length>0&&(t=[],this.polygonInformationStorage.forEach((function(o){var e=[];o.polygon.forEach((function(t){var o=[];t.forEach((function(t){o=g(t),t[0].toString()!==t[t.length-1].toString()&&o.push(t[0]),e.push(o)}))})),t.push(e)}))),this.mapStateService.updatePolygons(t),this.saveCurrentState()},t.prototype.saveCurrentState=function(){this.polygonInformationSubject.next(this.polygonInformationStorage),console.log("saveCurrentState: ",this.polygonInformationStorage)},t.prototype.deleteTrashcan=function(t){var o=this.polygonInformationStorage.findIndex((function(o){return o.polygon[0]===t}));this.polygonInformationStorage.splice(o,1),this.updatePolygons()},t.prototype.deleteTrashCanOnMulti=function(t){var o=0;console.log("DeleteTrashCan: ",t),console.log("deleteTrashCanOnMulti: ",this.polygonInformationStorage),this.polygonInformationStorage.forEach((function(e,n){console.log(e.polygon);var r=e.polygon.findIndex((function(o){return o.toString()===t.toString()}));r>=0&&(o=n,e.trashcanPoint.splice(r,1),e.sqmArea.splice(r,1),e.perimeter.splice(r,1),e.polygon.splice(r,1),console.log(e.polygon)),console.log("ID: ",r)})),this.updatePolygons(),console.log("Index: ",o),this.polygonInformationStorage.length>1&&this.polygonInformationStorage.splice(o,1),console.log("deleteTrashCanOnMulti: ",this.polygonInformationStorage)},t.prototype.deletePolygonInformationStorage=function(){this.polygonInformationStorage=[]},t.prototype.createPolygonInformationStorage=function(t){var o=this;console.log("Create Info: ",t),t.length>0&&(t.forEach((function(t){console.log(t.getLayers()[0].getLatLngs());var e=new P(t.getLayers()[0].getLatLngs());o.polygonInformationStorage.push(e)})),this.updatePolygons())},t.ctorParameters=function(){return[{type:h}]},t.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new t(o.ɵɵinject(h))},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[h])],t)}()),b={touchSupport:!0,mergePolygons:!0,kinks:!1,markers:{menu:!0,delete:!0,markerIcon:{styleClasses:["polygon-marker"]},holeIcon:{styleClasses:["polygon-marker","hole"]},markerMenuIcon:{position:4,styleClasses:["polygon-marker","menu"]},markerDeleteIcon:{position:1,styleClasses:["polygon-marker","delete"]}},polyLineOptions:{color:"#50622b",opacity:1,smoothFactor:0,noClip:!0,clickable:!1,weight:2},subtractLineOptions:{color:"#50622b",opacity:1,smoothFactor:0,noClip:!0,clickable:!1,weight:2},polygonOptions:{smoothFactor:.3,color:"#50622b",fillColor:"#b4cd8a",noClip:!0}},L=function(){function t(){this.simplyfiClicked=new o.EventEmitter,this.bboxClicked=new o.EventEmitter}return t.prototype.onSimplify=function(t){this.simplyfiClicked.emit(t)},t.prototype.onBbox=function(t){this.bboxClicked.emit(t)},l([o.Output(),u("design:type",o.EventEmitter)],t.prototype,"simplyfiClicked",void 0),l([o.Output(),u("design:type",o.EventEmitter)],t.prototype,"bboxClicked",void 0),t=l([o.Component({selector:"app-alter-polygon",template:'<div class="marker-menu-inner-wrapper">\r\n  <div class="marker-menu-header">Alter polygon</div>\r\n  <div class="marker-menu-content">\r\n    <div class="marker-menu-button simplify" (click)="onSimplify($event)">Simplify</div>\r\n    <div class="marker-menu-separator"></div>\r\n    <div class="marker-menu-button bbox" (click)="onBbox($event)" >bbox</div>\r\n  </div>\r\n</div>',styles:[""]})],t)}(),M=function(){function t(t,o){this.cfr=t,this.injector=o,this.clusterPopuprefs=[]}return t.prototype.ngOnDestroy=function(){this.destroyAngularPopupComponents()},t.prototype.generateAlterPopup=function(){var t=this.cfr.resolveComponentFactory(L).create(this.injector);return this.clusterPopuprefs.push(t),t},t.prototype.destroyAngularPopupComponents=function(){this.clusterPopuprefs.forEach((function(t){t&&t.destroy()})),this.clusterPopuprefs=[]},t.ctorParameters=function(){return[{type:o.ComponentFactoryResolver},{type:o.Injector}]},t.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new t(o.ɵɵinject(o.ComponentFactoryResolver),o.ɵɵinject(o.INJECTOR))},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[o.ComponentFactoryResolver,o.Injector])],t)}(),I=function(){function t(){}return t.prototype.createPolygon=function(t){return e.polygon(t)},t.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),k=function(){function a(o,a,i,s,l){var u=this;this.mapState=o,this.popupGenerator=a,this.turfHelper=i,this.polygonInformation=s,this.leafletHelper=l,this.drawModeSubject=new n.BehaviorSubject(t.DrawMode.Off),this.drawMode$=this.drawModeSubject.asObservable(),this.arrayOfFeatureGroups=[],this.tracer={},this.polygonDrawStates=null,this.ngUnsubscribe=new n.Subject,this.config=null,this.mapState.map$.pipe(r.filter((function(t){return null!==t}))).subscribe((function(t){u.map=t,console.log("Kartet: ",t),console.log("pre this.config",u.config),u.config=b,console.log("this.config",u.config),u.configurate({}),console.log("after this.config",u.config),u.tracer=e.polyline([[0,0]],u.config.polyLineOptions),u.initPolyDraw()})),this.polygonInformation.polygonInformation$.subscribe((function(t){console.log("PolyInfo start: ",t)}))}return a.prototype.configurate=function(t){this.config=s({},b,t),this.mergePolygons=this.config.mergePolygons,this.kinks=this.config.kinks},a.prototype.closeAndReset=function(){this.setDrawMode(t.DrawMode.Off),this.removeAllFeatureGroups()},a.prototype.deletePolygon=function(t){var o=this;console.log("deletePolygon: ",t),this.arrayOfFeatureGroups.length>0&&this.arrayOfFeatureGroups.forEach((function(e){var n=e.getLayers()[0],r=n.getLatLngs(),a=r.length;r.forEach((function(i,s){var l,u=g(i);console.log(i),i.length>1?(i[0][0]!==i[0][i[0].length-1]&&u[0].push(i[0][0]),l=[u[0]]):(i[0]!==i[i.length-1]&&u.push(i[0]),l=u),console.log("Test: ",l),console.log(t);var c=o.polygonArrayEquals(l,t);console.log("equals: ",c," length: ",a),c&&1===a?(o.polygonInformation.deleteTrashcan(t),o.removeFeatureGroup(e),console.log(e.getLayers())):c&&a>1&&(o.polygonInformation.deleteTrashCanOnMulti([t]),r.splice(s,1),n.setLatLngs(r),o.removeFeatureGroup(e),o.addPolygonLayer(n.toGeoJSON(),!1))}))}))},a.prototype.removeAllFeatureGroups=function(){var t=this;this.arrayOfFeatureGroups.forEach((function(o){t.map.removeLayer(o)})),this.arrayOfFeatureGroups=[],this.polygonInformation.deletePolygonInformationStorage(),this.polygonInformation.updatePolygons()},a.prototype.getDrawMode=function(){return this.drawModeSubject.value},a.prototype.addViken=function(t){this.addPolygonLayer(t,!0)},a.prototype.addAutoPolygon=function(t){var o=this,n=new e.FeatureGroup,r=this.turfHelper.getMultiPolygon(this.convertToCoords(t));console.log(r);var a=this.getPolygon(r);n.addLayer(a);var i=a.getLatLngs();console.log("markers: ",i),i.forEach((function(t){t.forEach((function(t,e){0===e?o.addMarker(t,n):(o.addHoleMarker(t,n),console.log("Hull: ",t))}))})),this.arrayOfFeatureGroups.push(n),this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups)},a.prototype.convertToCoords=function(t){var o=[];if(console.log(t.length,t),t.length>1&&t.length<3){var n=[];console.log(e.GeoJSON.latLngsToCoords(t[t.length-1]),t[t.length-1].length),(i=this.turfHelper.isWithin(e.GeoJSON.latLngsToCoords(t[t.length-1]),e.GeoJSON.latLngsToCoords(t[0])))?t.forEach((function(t){n.push(e.GeoJSON.latLngsToCoords(t))})):t.forEach((function(t){o.push([e.GeoJSON.latLngsToCoords(t)])})),n.length>=1&&o.push(n),console.log("Within1 ",i)}else if(t.length>2)for(var r=[],a=1;a<t.length-1;a++){var i;(i=this.turfHelper.isWithin(e.GeoJSON.latLngsToCoords(t[a]),e.GeoJSON.latLngsToCoords(t[0])))?(t.forEach((function(t){r.push(e.GeoJSON.latLngsToCoords(t))})),o.push(r)):t.forEach((function(t){o.push([e.GeoJSON.latLngsToCoords(t)])}))}else o.push([e.GeoJSON.latLngsToCoords(t[0])]);return console.log(o),o},a.prototype.initPolyDraw=function(){var o=this;console.log("initPolyDraw",this.map,this.tracer);var e=this.map.getContainer(),n=this.getDrawMode();this.config.touchSupport&&(e.addEventListener("touchstart",(function(e){n!==t.DrawMode.Off&&o.mouseDown(e)})),e.addEventListener("touchend",(function(e){n!==t.DrawMode.Off&&o.mouseUpLeave()})),e.addEventListener("touchmove",(function(e){n!==t.DrawMode.Off&&o.mouseMove(e)}))),this.tracer.addTo(this.map),this.setDrawMode(t.DrawMode.Off)},a.prototype.mouseDown=function(t){if(console.log("mouseDown",t),null!=t.originalEvent)this.tracer.setLatLngs([t.latlng]);else{var o=this.map.containerPointToLatLng([t.touches[0].clientX,t.touches[0].clientY]);this.tracer.setLatLngs([o])}this.startDraw()},a.prototype.mouseMove=function(t){if(null!=t.originalEvent)this.tracer.addLatLng(t.latlng);else{var o=this.map.containerPointToLatLng([t.touches[0].clientX,t.touches[0].clientY]);this.tracer.addLatLng(o)}},a.prototype.mouseUpLeave=function(){this.polygonInformation.deletePolygonInformationStorage();var o=this.turfHelper.turfConcaveman(this.tracer.toGeoJSON());switch(this.stopDraw(),this.getDrawMode()){case t.DrawMode.AddPolygon:this.addPolygon(o,!0);break;case t.DrawMode.SubtractPolygon:this.subtractPolygon(o)}this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups)},a.prototype.startDraw=function(){this.drawStartedEvents(!0)},a.prototype.stopDraw=function(){this.resetTracker(),this.drawStartedEvents(!1)},a.prototype.drawStartedEvents=function(t){var o=t?"on":"off";this.map[o]("mousemove",this.mouseMove,this),this.map[o]("mouseup",this.mouseUpLeave,this)},a.prototype.subtractPolygon=function(t){this.subtract(t)},a.prototype.addPolygon=function(t,o,e){void 0===e&&(e=!1),console.log("addPolygon",t,o,e,this.kinks,this.config),this.mergePolygons&&!e&&this.arrayOfFeatureGroups.length>0&&!this.kinks?this.merge(t):this.addPolygonLayer(t,o)},a.prototype.addPolygonLayer=function(o,n){var r=this,a=new e.FeatureGroup,i=n?this.turfHelper.getSimplified(o):o;console.log("AddPolygonLayer: ",i);var s=this.getPolygon(i);a.addLayer(s),console.log(s),s.getLatLngs().forEach((function(t){t.forEach((function(t,o){0===o?r.addMarker(t,a):(r.addHoleMarker(t,a),console.log("Hull: ",t))}))})),this.arrayOfFeatureGroups.push(a),console.log("Array: ",this.arrayOfFeatureGroups),this.setDrawMode(t.DrawMode.Off),a.on("click",(function(t){r.polygonClicked(t,i)}))},a.prototype.polygonClicked=function(t,o){var e=t.latlng;if("MultiPolygon"===o.geometry.type){var n=this.turfHelper.injectPointToPolygon(o,[e.lng,e.lat]);this.deletePolygon(this.getLatLngsFromJson(o)),this.addPolygonLayer(n,!1)}},a.prototype.getPolygon=function(t){console.log("getPolygons: ",t);var o=e.GeoJSON.geometryToLayer(t);return o.setStyle(this.config.polygonOptions),o},a.prototype.merge=function(t){var o=this;console.log("merge",t);var e=[],n=[];this.arrayOfFeatureGroups.forEach((function(r){var a=r.toGeoJSON();if(a.features[0].geometry.coordinates.length>1)a.features[0].geometry.coordinates.forEach((function(a){var i=o.turfHelper.getMultiPolygon([a]);o.turfHelper.polygonIntersect(i,t)&&(n.push(r),e.push(i))}));else{var i=o.turfHelper.getTurfPolygon(a.features[0]);o.turfHelper.polygonIntersect(i,t)&&(n.push(r),e.push(i))}})),console.log(n),n.length>0?this.unionPolygons(n,t,e):this.addPolygonLayer(t,!0)},a.prototype.subtract=function(t){var o=this,e=t;this.arrayOfFeatureGroups.forEach((function(t){var n=t.toGeoJSON(),r=n.features[0],a=o.getLatLngsFromJson(r),i=o.turfHelper.getTurfPolygon(n.features[0]),s=o.turfHelper.polygonDifference(i,e);o.deletePolygon(a),o.removeFeatureGroupOnMerge(t),e=s}));var n=e;this.turfHelper.getCoords(n).forEach((function(t){o.addPolygonLayer(o.turfHelper.getMultiPolygon([t]),!0)}))},a.prototype.events=function(t){var o=t?"on":"off";this.map[o]("mousedown",this.mouseDown,this)},a.prototype.addMarker=function(t,o){var n=this;t.forEach((function(t,r){var a=n.config.markers.markerIcon.styleClasses,i=new e.Marker(t,{icon:n.createDivIcon(a),draggable:!0,title:r.toString()});o.addLayer(i).addTo(n.map),i.on("drag",(function(t){n.markerDrag(o)})),i.on("dragend",(function(t){n.markerDragEnd(o)}))}))},a.prototype.addHoleMarker=function(t,o){var n=this;t.forEach((function(t,r){var a=n.config.markers.markerIcon.styleClasses,i=new e.Marker(t,{icon:n.createDivIcon(a),draggable:!0,title:r.toString()});o.addLayer(i).addTo(n.map),i.on("drag",(function(t){n.markerDrag(o)})),i.on("dragend",(function(t){n.markerDragEnd(o)}))}))},a.prototype.createDivIcon=function(t){var o=t.join(" ");return e.divIcon({className:o})},a.prototype.markerDrag=function(t){var o=[],e=[],n=[],r=t.getLayers(),a=r[0].getLatLngs();console.log(a);var i=0;if(a.length>1)for(var s=0;s<a.length;s++)if(e=[],n=[],console.log("Posisjoner: ",a[s]),0===s){if(a[0].length>1)for(var l=0;s<a[0].length;l++){console.log("Posisjoner 2: ",a[s][l]);for(var u=0;u<a[0][l].length;u++)e.push(r[u+1].getLatLng());n.push(e)}else{for(u=0;u<a[0][0].length;u++)e.push(r[u+1].getLatLng());n.push(e)}console.log("Hole: ",n),o.push(n)}else{i+=a[s-1][0].length,console.log("STart index: ",i);for(u=i;u<a[s][0].length+i;u++)e.push(r[u+1].getLatLng());n.push(e),o.push(n)}else{n=[];var c=0;for(s=0;s<a[0].length;s++){if(e=[],console.log("Polygon drag: ",a[0][s]),0===s)if(a[0][s].length>1)for(u=0;u<a[0][s].length;u++)e.push(r[u+1].getLatLng());else for(u=0;u<a[0][0].length;u++)e.push(r[u+1].getLatLng());else for(u=c+=a[0][s-1].length;u<a[0][s].length+c;u++)e.push(r[u+1].getLatLng());n.push(e)}o.push(n),console.log("Hole 2: ",n)}console.log("Nye posisjoner: ",o),r[0].setLatLngs(o)},a.prototype.markerDragEnd=function(t){var o=this;this.polygonInformation.deletePolygonInformationStorage();var e=t.toGeoJSON();if(console.log("Markerdragend polygon: ",e.features[0].geometry.coordinates),e.features[0].geometry.coordinates.length>1)e.features[0].geometry.coordinates.forEach((function(e){var n=o.turfHelper.getMultiPolygon([e]);if(console.log("Markerdragend: ",n),o.turfHelper.hasKinks(n)){o.kinks=!0;var r=o.turfHelper.getKinks(n);o.removeFeatureGroup(t),console.log("Unkink: ",r),r.forEach((function(t){o.addPolygon(o.turfHelper.getTurfPolygon(t),!1,!0)}))}else o.kinks=!1,o.addPolygon(n,!1)}));else{var n=this.turfHelper.getMultiPolygon(e.features[0].geometry.coordinates);if(console.log("Markerdragend: ",n),this.turfHelper.hasKinks(n)){this.kinks=!0;var r=this.turfHelper.getKinks(n);this.removeFeatureGroup(t),console.log("Unkink: ",r),r.forEach((function(t){o.addPolygon(o.turfHelper.getTurfPolygon(t),!1,!0)}))}else this.kinks=!1,this.addPolygon(n,!1)}this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups)},a.prototype.getLatLngsFromJson=function(t){var o;return console.log("getLatLngsFromJson: ",t),t&&(o=t.geometry.coordinates.length>1&&"MultiPolygon"===t.geometry.type?e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0][0]):t.geometry.coordinates[0].length>1&&"Polygon"===t.geometry.type?e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0]):e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0][0])),o},a.prototype.unionPolygons=function(t,o,e){var n=this;console.log("unionPolygons",t,o,e);var r=o;t.forEach((function(t,o){var a=t.toGeoJSON().features[0],i=n.getLatLngsFromJson(a),s=n.turfHelper.union(r,e[o]);n.deletePolygonOnMerge(i),n.removeFeatureGroup(t),r=s}));var a=r;this.addPolygonLayer(a,!0)},a.prototype.removeFeatureGroup=function(t){console.log("removeFeatureGroup",t),t.clearLayers(),this.arrayOfFeatureGroups=this.arrayOfFeatureGroups.filter((function(o){return o!==t})),this.map.removeLayer(t)},a.prototype.removeFeatureGroupOnMerge=function(t){console.log("removeFeatureGroupOnMerge",t);var o=[];if(t.getLayers()[0]){var e=t.getLayers()[0].getLatLngs()[0];this.polygonInformation.polygonInformationStorage.forEach((function(t){t.polygon.toString()!==e[0].toString()&&t.polygon[0].toString()===e[0][0].toString()&&(t.polygon=e,o.push(t)),t.polygon.toString()!==e[0].toString()&&t.polygon[0].toString()!==e[0][0].toString()&&o.push(t)})),t.clearLayers(),this.arrayOfFeatureGroups=this.arrayOfFeatureGroups.filter((function(o){return o!==t})),this.map.removeLayer(t)}},a.prototype.deletePolygonOnMerge=function(t){var o=this;console.log("deletePolygonOnMerge",t);var e=[];this.arrayOfFeatureGroups.length>0&&this.arrayOfFeatureGroups.forEach((function(n){var r=n.getLayers()[0].getLatLngs()[0];e=g(r[0]),r[0][0]!==r[0][r[0].length-1]&&e.push(r[0][0]),o.polygonArrayEqualsMerge(e,t)&&(console.log("EQUALS",t),o.removeFeatureGroupOnMerge(n),o.deletePolygon(t),o.polygonInformation.deleteTrashcan(t))}))},a.prototype.polygonArrayEqualsMerge=function(t,o){return t.toString()===o.toString()},a.prototype.polygonArrayEquals=function(t,o){if(t[0][0]){if(!t[0][0].equals(o[0][0]))return!1}else if(!t[0].equals(o[0]))return!1;return t.length===o.length},a.prototype.setLeafletMapEvents=function(t,o,e){t?this.map.dragging.enable():this.map.dragging.disable(),o?this.map.doubleClickZoom.enable():this.map.doubleClickZoom.disable(),e?this.map.scrollWheelZoom.enable():this.map.scrollWheelZoom.disable()},a.prototype.setDrawMode=function(o){if(console.log("setDrawMode",this.map),this.drawModeSubject.next(o),this.map){switch(o){case t.DrawMode.Off:e.DomUtil.removeClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!1),this.stopDraw(),this.tracer.setStyle({color:""}),this.setLeafletMapEvents(!0,!0,!0),!1;break;case t.DrawMode.AddPolygon:e.DomUtil.addClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!0),this.tracer.setStyle({color:b.polyLineOptions.color}),this.setLeafletMapEvents(!1,!1,!1);break;case t.DrawMode.SubtractPolygon:e.DomUtil.addClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!0),this.tracer.setStyle({color:"#D9460F"}),this.setLeafletMapEvents(!1,!1,!1)}}},a.prototype.modeChange=function(t){this.setDrawMode(t),this.polygonInformation.saveCurrentState()},a.prototype.drawModeClick=function(){this.setDrawMode(t.DrawMode.AddPolygon),this.polygonInformation.saveCurrentState()},a.prototype.freedrawMenuClick=function(){this.setDrawMode(t.DrawMode.AddPolygon),this.polygonInformation.saveCurrentState()},a.prototype.subtractClick=function(){this.setDrawMode(t.DrawMode.SubtractPolygon),this.polygonInformation.saveCurrentState()},a.prototype.resetTracker=function(){this.tracer.setLatLngs([[0,0]])},a.prototype.toggleMarkerMenu=function(){alert("open menu")},a.prototype.getHtmlContent=function(t){var o=this.popupGenerator.generateAlterPopup();return o.instance.bboxClicked.subscribe((function(o){console.log("bbox clicked",o),t(o)})),o.instance.simplyfiClicked.subscribe((function(o){console.log("simplyfi clicked",o),t(o)})),o.location.nativeElement},a.prototype.convertToBoundsPolygon=function(t){this.leafletHelper.createPolygon(t)},a.prototype.getMarkerIndex=function(t,o){var e=y.getBounds(t,Math.sqrt(2)/2),n=new d(e.getWest(),e.getSouth(),e.getEast(),e.getNorth()).getDirection(o),r={lat:n[1],lng:n[0]},a=this.turfHelper.getCoord(r),i=this.turfHelper.getFeaturePointCollection(t);return this.turfHelper.getNearestPointIndex(a,i)},a.ctorParameters=function(){return[{type:h},{type:M},{type:m},{type:S},{type:I}]},a.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new a(o.ɵɵinject(h),o.ɵɵinject(M),o.ɵɵinject(m),o.ɵɵinject(S),o.ɵɵinject(I))},token:a,providedIn:"root"}),a=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[h,M,m,S,I])],a)}();!function(t){t[t.Off=0]="Off",t[t.AddPolygon=1]="AddPolygon",t[t.EditPolygon=2]="EditPolygon",t[t.SubtractPolygon=3]="SubtractPolygon",t[t.LoadPolygon=4]="LoadPolygon"}(t.DrawMode||(t.DrawMode={}));var w=function(){function t(){}return t=l([o.NgModule({declarations:[L],imports:[],exports:[]})],t)}();t.ComponentGeneraterService=M,t.MapStateService=h,t.MyLibModule=w,t.PolyDrawService=k,t.PolygonInformationService=S,t.ɵa=m,t.ɵb=I,t.ɵc=L,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=my-lib.umd.min.js.map