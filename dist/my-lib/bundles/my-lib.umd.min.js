!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("@angular/core"),require("leaflet"),require("rxjs"),require("rxjs/operators"),require("@turf/turf"),require("concaveman")):"function"==typeof define&&define.amd?define("my-lib",["exports","@angular/core","leaflet","rxjs","rxjs/operators","@turf/turf","concaveman"],o):o((t=t||self)["my-lib"]={},t.ng.core,t.leaflet,t.rxjs,t.rxjs.operators,t.turf,t.concaveman)}(this,(function(t,o,e,n,r,i,a){"use strict";a=a&&a.hasOwnProperty("default")?a.default:a;var s=function(){return(s=Object.assign||function(t){for(var o,e=1,n=arguments.length;e<n;e++)for(var r in o=arguments[e])Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r]);return t}).apply(this,arguments)};function l(t,o,e,n){var r,i=arguments.length,a=i<3?o:null===n?n=Object.getOwnPropertyDescriptor(o,e):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,o,e,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(i<3?r(a):i>3?r(o,e,a):r(o,e))||a);return i>3&&a&&Object.defineProperty(o,e,a),a}function u(t,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,o)}function c(t,o){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,r,i=e.call(t),a=[];try{for(;(void 0===o||o-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(t){r={error:t}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return a}function g(){for(var t=[],o=0;o<arguments.length;o++)t=t.concat(c(arguments[o]));return t}var p,h,f=function(){function t(){this.mapSubject=new n.BehaviorSubject(null),this.map$=this.mapSubject.asObservable(),this.polygonSubject=new n.BehaviorSubject(null),this.polygons$=this.polygonSubject.asObservable(),this.mapStateSubject=new n.BehaviorSubject(new y),this.mapState$=this.mapStateSubject.asObservable(),this.mapZoomLevel$=this.mapState$.pipe(r.map((function(t){return t.mapBoundState.zoom})))}return t.prototype.updateMapStates=function(t){var o=this.mapStateSubject.value;o=s(s({},o),t),this.mapStateSubject.next(o)},t.prototype.updateMapState=function(t){this.mapSubject.next(t)},t.prototype.updatePolygons=function(t){console.log("map-state",t),this.polygonSubject.next(t)},t.prototype.updateMapBounds=function(t){this.updateMapStates({mapBoundState:t})},t.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),y=function(t){void 0===t&&(t=new d(null,11)),this.mapBoundState=t},d=function(t,o){this.bounds=t,this.zoom=o};(p=t.DrawMode||(t.DrawMode={}))[p.Off=0]="Off",p[p.Add=1]="Add",p[p.Edit=2]="Edit",p[p.Subtract=4]="Subtract",p[p.AppendMarker=8]="AppendMarker",p[p.LoadPredefined=16]="LoadPredefined",(h=t.MarkerPosition||(t.MarkerPosition={}))[h.North=1]="North",h[h.East=2]="East",h[h.South=3]="South",h[h.West=4]="West",h[h.NorthEast=5]="NorthEast",h[h.NorthWest=6]="NorthWest",h[h.SouthEast=7]="SouthEast",h[h.SouthWest=8]="SouthWest";var m=function(){function t(){}return t.getBounds=function(t,o){void 0===o&&(o=0);var n=[];t.forEach((function(t){isNaN(t.lat)||isNaN(t.lng),n.push(t)}));var r=new e.Polyline(n).getBounds();return 0!==o?r.pad(o):r},t}(),v=function(){function o(t,o,e,n){void 0===t&&(t=0),void 0===o&&(o=0),void 0===e&&(e=0),void 0===n&&(n=0),this.direction={East:{lat:0,lng:0},North:{lat:0,lng:0},NorthEast:{lat:0,lng:0},NorthWest:{lat:0,lng:0},South:{lat:0,lng:0},SouthEast:{lat:0,lng:0},SouthWest:{lat:0,lng:0},West:{lat:0,lng:0}},this.direction.North={lat:e,lng:(o+n)/2},this.direction.NorthEast={lat:e,lng:n},this.direction.East={lat:(t+e)/2,lng:n},this.direction.SouthEast={lat:t,lng:n},this.direction.South={lat:t,lng:(o+n)/2},this.direction.SouthWest={lat:t,lng:o},this.direction.West={lat:(t+e)/2,lng:o},this.direction.NorthWest={lat:e,lng:o}}return o.prototype.getDirection=function(o){switch(o){case t.MarkerPosition.North:return this.direction.North;case t.MarkerPosition.NorthEast:return this.direction.NorthEast;case t.MarkerPosition.East:return this.direction.East;case t.MarkerPosition.SouthEast:return this.direction.SouthEast;case t.MarkerPosition.South:return this.direction.South;case t.MarkerPosition.SouthWest:return this.direction.SouthWest;case t.MarkerPosition.West:return this.direction.West;case t.MarkerPosition.NorthWest:return this.direction.NorthWest;default:return this.direction.North}},o.prototype.getPositions=function(o,e,n){void 0===o&&(o=t.MarkerPosition.SouthWest),void 0===e&&(e=!1),void 0===n&&(n=!0);var r=[];return r.push([this.direction.SouthWest.lng,this.direction.SouthWest.lat]),r.push([this.direction.SouthWest.lng,this.direction.SouthWest.lat]),r.push([this.direction.South.lng,this.direction.South.lat]),r.push([this.direction.SouthEast.lng,this.direction.SouthEast.lat]),r.push([this.direction.East.lng,this.direction.East.lat]),r.push([this.direction.NorthEast.lng,this.direction.NorthEast.lat]),r.push([this.direction.North.lng,this.direction.North.lat]),r.push([this.direction.NorthWest.lng,this.direction.NorthWest.lat]),r.push([this.direction.West.lng,this.direction.West.lat]),n&&r.push([this.direction.SouthWest.lng,this.direction.SouthWest.lat]),r},o}(),S=function(){function t(){this.simplifyTolerance={tolerance:1e-4,highQuality:!1}}return t.prototype.union=function(t,o){console.log("poly1: ",t),console.log("poly2: ",o);var e=i.union(t,o);return this.getTurfPolygon(e)},t.prototype.turfConcaveman=function(t){var o=i.explode(t).features.map((function(t){return t.geometry.coordinates}));return i.multiPolygon([[a(o)]])},t.prototype.getSimplified=function(t){var o=this.simplifyTolerance;return i.simplify(t,o)},t.prototype.getTurfPolygon=function(t){return console.log("Get TurfPolygon:",t),"Polygon"===t.geometry.type?i.multiPolygon([t.geometry.coordinates]):i.multiPolygon(t.geometry.coordinates)},t.prototype.getMultiPolygon=function(t){return i.multiPolygon(t)},t.prototype.getKinks=function(t){var o=i.unkinkPolygon(t),e=[];return i.featureEach(o,(function(t){e.push(t)})),e},t.prototype.getCoords=function(t){return i.getCoords(t)},t.prototype.hasKinks=function(t){return i.kinks(t).features.length>0},t.prototype.polygonIntersect=function(t,o){var e=[],n=[];console.log("polygonIntersect",t,o),i.getCoords(o).forEach((function(t){var o={type:"Polygon",coordinates:[t[0]]};e.push(o)})),i.getCoords(t).forEach((function(t){var o={type:"Polygon",coordinates:[t[0]]};n.push(o)}));var r=!1;t:for(var a=0;a<e.length;a++)if(this.getKinks(e[a]).length<2)for(var s=0;s<n.length;s++)if(this.getKinks(n[s]).length<2&&(r=!!i.intersect(e[a],n[s])))break t;return r},t.prototype.getIntersection=function(t,o){return i.intersect(t,o)},t.prototype.getDistance=function(t,o){return i.distance(t,o)},t.prototype.isWithin=function(t,o){return console.log(t),console.log("Ytre: ",o),i.booleanWithin(i.polygon([t]),i.polygon([o]))},t.prototype.equalPolygons=function(t,o){console.log(t),console.log(o),console.log(i.booleanEqual(t,o))},t.prototype.convertToBoundingBoxPolygon=function(t,o){void 0===o&&(o=!1);var e=i.bbox(t.geometry),n=i.bboxPolygon(e),r=new v(e[1],e[0],e[3],e[2]).getPositions();return n.geometry.coordinates=[],n.geometry.coordinates=[r],n},t.prototype.polygonToMultiPolygon=function(t){return i.multiPolygon([t.geometry.coordinates])},t.prototype.injectPointToPolygon=function(t,o){var e,n=i.getCoords(t);if(console.log("polygon: ",t),n.length<2){var r=i.explode(t);console.log(i.nearestPoint(o,r));var a=i.nearestPoint(o,r).properties.featureIndex,s=i.coordReduce(r,(function(t,e,n){return g(t,a===n?[e,o]:[e])}),[]);console.log("test",s),e=i.multiPolygon([[s]])}else{var l=[],u=[];n.forEach((function(t){var e=i.polygon(t);if(i.booleanPointInPolygon(o,e)){var n=i.explode(e),r=i.nearestPoint(o,n).properties.featureIndex;u=i.coordReduce(n,(function(t,e,n){return g(t,r===n?[e,o]:[e])}),[]),console.log("coordinates",u)}else l.push(t)})),l.push([u]),e=i.multiPolygon(l)}return e},t.prototype.polygonDifference=function(t,o){var e=i.difference(t,o);return console.log(e),this.getTurfPolygon(e)},t.prototype.getBoundingBoxCompassPosition=function(t,o,e,n){this.getMultiPolygon(t);var r=this.getBoundingBoxCompass(t),a=i.explode(t),s=this.getCoord(r.direction.North);i.nearestPoint(s,a);return null},t.prototype.getBoundingBoxCompass=function(t){var o=this.getMultiPolygon(t),e=(i.centerOfMass(o),i.bbox(o)),n=e[0],r=e[1],a=e[2],s=e[3];return new v(n,r,a,s)},t.prototype.getNearestPointIndex=function(t,o){return i.nearestPoint(t,o).properties.featureIndex},t.prototype.getCoord=function(t){return i.getCoord([t.lng,t.lat])},t.prototype.getFeaturePointCollection=function(t){var o=[];return t.forEach((function(t){var e=i.point([t.lng,t.lat],{});o.push(e)})),i.featureCollection(o)},t.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),P=function(){function t(){}return t.getCenter=function(t){var o=Math.PI,e=0,n=0,r=0;t.forEach((function(t){var i=t.lat,a=t.lng;i=i*o/180,a=a*o/180,e+=Math.cos(i)*Math.cos(a),n+=Math.cos(i)*Math.sin(a),r+=Math.sin(i)}));var i=Math.atan2(n,e),a=Math.sqrt(e*e+n*n),s=Math.atan2(r,a);return{lat:s=180*s/o,lng:i=180*i/o}},t.getSouthWest=function(t){return this.getBounds(t).getNorthWest()},t.getNorthEast=function(t){return this.getBounds(t).getNorthEast()},t.getNorthWest=function(t){return this.getBounds(t).getNorthWest()},t.getSouthEast=function(t){return this.getBounds(t).getSouthEast()},t.getNorth=function(t){return this.getBounds(t).getNorth()},t.getSouth=function(t){return this.getBounds(t).getSouth()},t.getWest=function(t){return this.getBounds(t).getWest()},t.getEast=function(t){return this.getBounds(t).getEast()},t.getSqmArea=function(t){var o=new e.Polygon(t).toGeoJSON();return i.area(o)},t.getPerimeter=function(t){var o=new e.Polygon(t).toGeoJSON();return i.length(o,{units:"meters"})},t.getPolygonChecksum=function(t){var o=t.filter((function(t,o,e){return e.indexOf(e.find((function(o){return o.lat===t.lat&&o.lng===t.lng})))===o}));return o.reduce((function(t,o){return+t+ +o.lat}),0)*o.reduce((function(t,o){return+t+ +o.lng}),0)},t.getMidPoint=function(t,o){var e=i.point([t.lng,t.lat]),n=i.point([o.lng,o.lat]),r=i.midpoint(e,n);return{lat:r.geometry.coordinates[1],lng:r.geometry.coordinates[0]}},t.getBounds=function(t){var o=[];return t.forEach((function(t){isNaN(t.lat)||isNaN(t.lng),o.push(t)})),new e.Polyline(o).getBounds()},t}(),M=function(){function t(t){var o=this;this.polygon=[],this.trashcanPoint=[],this.sqmArea=[],this.perimeter=[],console.log("PolygonInfo: ",t),t.forEach((function(t,e){o.trashcanPoint[e]=o.getTrashcanPoint(t[0]),o.sqmArea[e]=o.calculatePolygonArea(t[0]),o.perimeter[e]=o.calculatePolygonPerimeter(t[0]),console.log(t[0]),o.polygon[e]=t}))}return t.prototype.setSqmArea=function(t){this.sqmArea[0]=t},t.prototype.getTrashcanPoint=function(t){var o,e,n=Math.max.apply(Math,t.map((function(t){return t.lat}))),r=t.findIndex((function(t){return t.lat===n}));r>0?(o=t[r-1],e=r<t.length-1?t[r+1]:t[0]):(o=t[t.length-1],e=t[r+1]);var i=o.lng<e.lng?o:e;return P.getMidPoint(t[r],i)},t.prototype.calculatePolygonArea=function(t){return P.getSqmArea(t)},t.prototype.calculatePolygonPerimeter=function(t){return P.getPerimeter(t)},t}(),b=function(t,o){for(var e=document.querySelectorAll(t),n=0;n<e.length;n++)e.item(n).classList.add(o)},k=b,w=function(t,o){for(var e=document.querySelectorAll(t),n=0;n<e.length;n++)e.item(n).classList.remove(o)},I=w,L=function(){function t(){this.canUsePolyDraw=!1,this.reset()}return t.prototype.activate=function(){this.reset(),this.isActivated=!0},t.prototype.reset=function(){this.isActivated=!1,this.hasPolygons=!1,this.canRevert=!1,this.isAuto=!1,this.resetDrawModes()},t.prototype.resetDrawModes=function(){this.isFreeDrawMode=!1,w("img.leaflet-tile","disable-events"),this.isMoveMode=!1},t.prototype.setFreeDrawMode=function(t){void 0===t&&(t=!1),t&&(this.isActivated=!0),this.isActivated&&(this.resetDrawModes(),this.isFreeDrawMode=!0,b("img.leaflet-tile","disable-events"),t&&(this.isAuto=!0))},t.prototype.setMoveMode=function(){this.isActivated&&(this.resetDrawModes(),this.isMoveMode=!0)},t.prototype.forceCanUseFreeDraw=function(){this.canUsePolyDraw=!0},t}(),D=function(){function t(t){this.mapStateService=t,this.polygonInformationSubject=new n.Subject,this.polygonInformation$=this.polygonInformationSubject.asObservable(),this.polygonDrawStatesSubject=new n.Subject,this.polygonDrawStates$=this.polygonDrawStatesSubject.asObservable(),this.polygonDrawStates=null,this.polygonInformationStorage=[],this.polygonDrawStates=new L}return t.prototype.updatePolygons=function(){console.log("updatePolygons: ",this.polygonInformationStorage);var t=null;this.polygonInformationStorage.length>0?(t=[],this.polygonInformationStorage.forEach((function(o){var e=[];o.polygon.forEach((function(t){var o=[];t.forEach((function(t){o=g(t),t[0].toString()!==t[t.length-1].toString()&&o.push(t[0]),e.push(o)}))})),t.push(e)})),this.polygonDrawStates.hasPolygons=!0):(this.polygonDrawStates.reset(),this.polygonDrawStates.hasPolygons=!1),this.mapStateService.updatePolygons(t),this.saveCurrentState()},t.prototype.saveCurrentState=function(){this.polygonInformationSubject.next(this.polygonInformationStorage),this.polygonDrawStatesSubject.next(this.polygonDrawStates),console.log("saveCurrentState: ",this.polygonInformationStorage)},t.prototype.deleteTrashcan=function(t){var o=this.polygonInformationStorage.findIndex((function(o){return o.polygon[0]===t}));this.polygonInformationStorage.splice(o,1),this.updatePolygons()},t.prototype.deleteTrashCanOnMulti=function(t){var o=0;console.log("DeleteTrashCan: ",t),console.log("deleteTrashCanOnMulti: ",this.polygonInformationStorage),this.polygonInformationStorage.forEach((function(e,n){console.log(e.polygon);var r=e.polygon.findIndex((function(o){return o.toString()===t.toString()}));r>=0&&(o=n,e.trashcanPoint.splice(r,1),e.sqmArea.splice(r,1),e.perimeter.splice(r,1),e.polygon.splice(r,1),console.log(e.polygon)),console.log("ID: ",r)})),this.updatePolygons(),console.log("Index: ",o),this.polygonInformationStorage.length>1&&this.polygonInformationStorage.splice(o,1),console.log("deleteTrashCanOnMulti: ",this.polygonInformationStorage)},t.prototype.deletePolygonInformationStorage=function(){this.polygonInformationStorage=[]},t.prototype.createPolygonInformationStorage=function(t){var o=this;console.log("Create Info: ",t),t.length>0&&(t.forEach((function(t){console.log(t.getLayers()[0].getLatLngs());var e=new M(t.getLayers()[0].getLatLngs());o.polygonInformationStorage.push(e)})),this.updatePolygons())},t.prototype.activate=function(){this.polygonDrawStates.activate()},t.prototype.reset=function(){this.polygonDrawStates.reset()},t.prototype.setMoveMode=function(){this.polygonDrawStates.setMoveMode()},t.prototype.setFreeDrawMode=function(){this.polygonDrawStates.setFreeDrawMode()},t.ctorParameters=function(){return[{type:f}]},t.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new t(o["ɵɵinject"](f))},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[f])],t)}(),E={touchSupport:!0,mergePolygons:!0,kinks:!1,markers:{menu:!0,delete:!0,markerIcon:{styleClasses:["polygon-marker"]},holeIcon:{styleClasses:["polygon-marker","hole"]},markerMenuIcon:{position:4,styleClasses:["polygon-marker","menu"]},markerDeleteIcon:{position:1,styleClasses:["polygon-marker","delete"]}},polyLineOptions:{color:"#50622b",opacity:1,smoothFactor:0,noClip:!0,clickable:!1,weight:2},subtractLineOptions:{color:"#50622b",opacity:1,smoothFactor:0,noClip:!0,clickable:!1,weight:2},polygonOptions:{smoothFactor:.3,color:"#50622b",fillColor:"#b4cd8a",noClip:!0}},C=function(){function t(){this.simplyfiClicked=new o.EventEmitter,this.bboxClicked=new o.EventEmitter}return t.prototype.onSimplify=function(t){this.simplyfiClicked.emit(t)},t.prototype.onBbox=function(t){this.bboxClicked.emit(t)},l([o.Output(),u("design:type",o.EventEmitter)],t.prototype,"simplyfiClicked",void 0),l([o.Output(),u("design:type",o.EventEmitter)],t.prototype,"bboxClicked",void 0),t=l([o.Component({selector:"app-alter-polygon",template:'<div class="marker-menu-inner-wrapper">\r\n  <div class="marker-menu-header">Alter polygon</div>\r\n  <div class="marker-menu-content">\r\n    <div class="marker-menu-button simplify" (click)="onSimplify($event)">Simplify</div>\r\n    <div class="marker-menu-separator"></div>\r\n    <div class="marker-menu-button bbox" (click)="onBbox($event)" >bbox</div>\r\n  </div>\r\n</div>',styles:[""]})],t)}(),O=function(){function t(t,o){this.cfr=t,this.injector=o,this.clusterPopuprefs=[]}return t.prototype.ngOnDestroy=function(){this.destroyAngularPopupComponents()},t.prototype.generateAlterPopup=function(){var t=this.cfr.resolveComponentFactory(C).create(this.injector);return this.clusterPopuprefs.push(t),t},t.prototype.destroyAngularPopupComponents=function(){this.clusterPopuprefs.forEach((function(t){t&&t.destroy()})),this.clusterPopuprefs=[]},t.ctorParameters=function(){return[{type:o.ComponentFactoryResolver},{type:o.Injector}]},t.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new t(o["ɵɵinject"](o.ComponentFactoryResolver),o["ɵɵinject"](o.INJECTOR))},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[o.ComponentFactoryResolver,o.Injector])],t)}(),j=function(){function t(){}return t.prototype.createPolygon=function(t){return e.polygon(t)},t.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new t},token:t,providedIn:"root"}),t=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),N=function(){function i(o,i,a,s,l){var u=this;this.mapState=o,this.popupGenerator=i,this.turfHelper=a,this.polygonInformation=s,this.leafletHelper=l,this.drawModeSubject=new n.BehaviorSubject(t.DrawMode.Off),this.drawMode$=this.drawModeSubject.asObservable(),this.minimumFreeDrawZoomLevel=12,this.arrayOfFeatureGroups=[],this.tracer={},this.ngUnsubscribe=new n.Subject,this.config=null,this.mapState.map$.pipe(r.filter((function(t){return null!==t}))).subscribe((function(t){u.map=t,console.log("Kartet i polydraw: ",u.map),console.log("pre this.config",u.config),u.config=E,console.log("this.config",u.config),u.configurate({}),console.log("after this.config",u.config),u.tracer=e.polyline([[0,0]],u.config.polyLineOptions),console.log("Tracer pipe: ",u.tracer),u.initPolyDraw()})),this.mapState.mapZoomLevel$.pipe(r.debounceTime(100),r.takeUntil(this.ngUnsubscribe)).subscribe((function(t){u.onZoomChange(t)})),this.polygonInformation.polygonInformation$.subscribe((function(t){console.log("PolyInfo start: ",t)}))}return i.prototype.configurate=function(t){this.config=s(s({},E),t),this.mergePolygons=this.config.mergePolygons,this.kinks=this.config.kinks},i.prototype.closeAndReset=function(){this.setDrawMode(t.DrawMode.Off),this.removeAllFeatureGroups()},i.prototype.deletePolygon=function(t){var o=this;console.log("deletePolygon: ",t),this.arrayOfFeatureGroups.length>0&&this.arrayOfFeatureGroups.forEach((function(e){var n=e.getLayers()[0],r=n.getLatLngs(),i=r.length;r.forEach((function(a,s){var l,u=g(a);console.log(a),a.length>1?l=[u[0]]:(a[0]!==a[a.length-1]&&u.push(a[0]),l=u),console.log("Test: ",l),console.log(t);var c=o.polygonArrayEquals(l,t);console.log("equals: ",c," length: ",i),c&&1===i?(o.polygonInformation.deleteTrashcan(t),o.removeFeatureGroup(e),console.log(e.getLayers())):c&&i>1&&(o.polygonInformation.deleteTrashCanOnMulti([t]),r.splice(s,1),n.setLatLngs(r),o.removeFeatureGroup(e),o.addPolygonLayer(n.toGeoJSON(),!1))}))}))},i.prototype.removeAllFeatureGroups=function(){var t=this;this.arrayOfFeatureGroups.forEach((function(o){t.map.removeLayer(o)})),this.arrayOfFeatureGroups=[],this.polygonInformation.deletePolygonInformationStorage(),this.polygonInformation.reset(),this.polygonInformation.updatePolygons()},i.prototype.getDrawMode=function(){return this.drawModeSubject.value},i.prototype.addViken=function(t){this.addPolygonLayer(t,!0)},i.prototype.addAutoPolygon=function(t){var o=this,n=new e.FeatureGroup,r=this.turfHelper.getMultiPolygon(this.convertToCoords(t));console.log(r);var i=this.getPolygon(r);n.addLayer(i);var a=i.getLatLngs();console.log("markers: ",a),a.forEach((function(t){t.forEach((function(t,e){0===e?o.addMarker(t,n):(o.addHoleMarker(t,n),console.log("Hull: ",t))}))})),this.arrayOfFeatureGroups.push(n),this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups),this.polygonInformation.activate(),this.polygonInformation.setMoveMode()},i.prototype.convertToCoords=function(t){var o=[];if(console.log(t.length,t),t.length>1&&t.length<3){var n=[];console.log(e.GeoJSON.latLngsToCoords(t[t.length-1]),t[t.length-1].length),(a=this.turfHelper.isWithin(e.GeoJSON.latLngsToCoords(t[t.length-1]),e.GeoJSON.latLngsToCoords(t[0])))?t.forEach((function(t){n.push(e.GeoJSON.latLngsToCoords(t))})):t.forEach((function(t){o.push([e.GeoJSON.latLngsToCoords(t)])})),n.length>=1&&o.push(n),console.log("Within1 ",a)}else if(t.length>2)for(var r=[],i=1;i<t.length-1;i++){var a;(a=this.turfHelper.isWithin(e.GeoJSON.latLngsToCoords(t[i]),e.GeoJSON.latLngsToCoords(t[0])))?(t.forEach((function(t){r.push(e.GeoJSON.latLngsToCoords(t))})),o.push(r)):t.forEach((function(t){o.push([e.GeoJSON.latLngsToCoords(t)])}))}else o.push([e.GeoJSON.latLngsToCoords(t[0])]);return console.log(o),o},i.prototype.initPolyDraw=function(){var o=this,e=this.map.getContainer(),n=this.getDrawMode();this.config.touchSupport&&(e.addEventListener("touchstart",(function(e){n!==t.DrawMode.Off&&o.mouseDown(e)})),e.addEventListener("touchend",(function(e){n!==t.DrawMode.Off&&o.mouseUpLeave()})),e.addEventListener("touchmove",(function(e){n!==t.DrawMode.Off&&o.mouseMove(e)}))),console.log("Map init: ",this.map),console.log("Tracer init: ",this.tracer),this.map.addLayer(this.tracer),this.setDrawMode(t.DrawMode.Off)},i.prototype.mouseDown=function(t){if(console.log("mouseDown",t),null!=t.originalEvent)this.tracer.setLatLngs([t.latlng]);else{var o=this.map.containerPointToLatLng([t.touches[0].clientX,t.touches[0].clientY]);this.tracer.setLatLngs([o])}this.startDraw()},i.prototype.mouseMove=function(t){if(null!=t.originalEvent)this.tracer.addLatLng(t.latlng);else{var o=this.map.containerPointToLatLng([t.touches[0].clientX,t.touches[0].clientY]);this.tracer.addLatLng(o)}},i.prototype.mouseUpLeave=function(){this.polygonInformation.deletePolygonInformationStorage();var o=this.turfHelper.turfConcaveman(this.tracer.toGeoJSON());switch(this.stopDraw(),this.getDrawMode()){case t.DrawMode.Add:this.addPolygon(o,!0);break;case t.DrawMode.Subtract:this.subtractPolygon(o)}this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups)},i.prototype.startDraw=function(){this.drawStartedEvents(!0)},i.prototype.stopDraw=function(){this.resetTracker(),this.drawStartedEvents(!1)},i.prototype.onZoomChange=function(t){t>=this.minimumFreeDrawZoomLevel?this.polygonInformation.polygonDrawStates.canUsePolyDraw=!0:(this.polygonInformation.polygonDrawStates.canUsePolyDraw=!1,this.polygonInformation.setMoveMode()),this.polygonInformation.saveCurrentState()},i.prototype.drawStartedEvents=function(t){var o=t?"on":"off";this.map[o]("mousemove",this.mouseMove,this),this.map[o]("mouseup",this.mouseUpLeave,this)},i.prototype.subtractPolygon=function(t){this.subtract(t)},i.prototype.addPolygon=function(t,o,e){void 0===e&&(e=!1),console.log("addPolygon",t,o,e,this.kinks,this.config),this.mergePolygons&&!e&&this.arrayOfFeatureGroups.length>0&&!this.kinks?this.merge(t):this.addPolygonLayer(t,o)},i.prototype.addPolygonLayer=function(o,n){var r=this,i=new e.FeatureGroup,a=n?this.turfHelper.getSimplified(o):o;console.log("AddPolygonLayer: ",a);var s=this.getPolygon(a);i.addLayer(s),console.log(s),s.getLatLngs().forEach((function(t){t.forEach((function(t,o){0===o?r.addMarker(t,i):(r.addHoleMarker(t,i),console.log("Hull: ",t))}))})),this.arrayOfFeatureGroups.push(i),console.log("Array: ",this.arrayOfFeatureGroups),this.polygonInformation.activate(),this.setDrawMode(t.DrawMode.Off),i.on("click",(function(t){r.polygonClicked(t,a)}))},i.prototype.polygonClicked=function(t,o){var e=t.latlng;if("MultiPolygon"===o.geometry.type){var n=this.turfHelper.injectPointToPolygon(o,[e.lng,e.lat]);this.deletePolygon(this.getLatLngsFromJson(o)),this.addPolygonLayer(n,!1)}},i.prototype.getPolygon=function(t){console.log("getPolygons: ",t);var o=e.GeoJSON.geometryToLayer(t);return o.setStyle(this.config.polygonOptions),o},i.prototype.merge=function(t){var o=this;console.log("merge",t);var e=[],n=[];this.arrayOfFeatureGroups.forEach((function(r){var i=r.toGeoJSON();if(console.log("Merger: ",i.features[0]),i.features[0].geometry.coordinates.length>1)i.features[0].geometry.coordinates.forEach((function(i){var a=o.turfHelper.getMultiPolygon([i]);o.turfHelper.polygonIntersect(a,t)&&(n.push(r),e.push(a))}));else{var a=o.turfHelper.getTurfPolygon(i.features[0]);o.turfHelper.polygonIntersect(a,t)&&(n.push(r),e.push(a))}})),console.log(n),n.length>0?this.unionPolygons(n,t,e):this.addPolygonLayer(t,!0)},i.prototype.subtract=function(t){var o=this,e=t;this.arrayOfFeatureGroups.forEach((function(t){var n=t.toGeoJSON(),r=n.features[0],i=o.getLatLngsFromJson(r),a=o.turfHelper.getTurfPolygon(n.features[0]),s=o.turfHelper.polygonDifference(a,e);o.deletePolygon(i),o.removeFeatureGroupOnMerge(t),e=s}));var n=e;this.turfHelper.getCoords(n).forEach((function(t){o.addPolygonLayer(o.turfHelper.getMultiPolygon([t]),!0)}))},i.prototype.events=function(t){var o=t?"on":"off";this.map[o]("mousedown",this.mouseDown,this)},i.prototype.addMarker=function(t,o){var n=this,r=this.getMarkerIndex(t,this.config.markers.markerMenuIcon.position),i=this.getMarkerIndex(t,this.config.markers.markerDeleteIcon.position);t.forEach((function(a,s){var l=n.config.markers.markerIcon.styleClasses;s===r&&n.config.markers.menu&&(l=n.config.markers.markerMenuIcon.styleClasses),s===i&&n.config.markers.delete&&(l=n.config.markers.markerDeleteIcon.styleClasses);var u=new e.Marker(a,{icon:n.createDivIcon(l),draggable:!0,title:s.toString()});o.addLayer(u).addTo(n.map),u.on("drag",(function(t){n.markerDrag(o)})),u.on("dragend",(function(t){n.markerDragEnd(o)})),s===r&&n.config.markers.menu&&(u.bindPopup(n.getHtmlContent((function(t){console.log("clicked on",t.target)}))),u.on("click",(function(o){n.convertToBoundsPolygon(t,!0),n.convertToSimplifiedPolygon(t)}))),s===i&&n.config.markers.delete&&u.on("click",(function(o){n.deletePolygon([t])}))}))},i.prototype.addHoleMarker=function(t,o){var n=this;t.forEach((function(t,r){var i=n.config.markers.markerIcon.styleClasses,a=new e.Marker(t,{icon:n.createDivIcon(i),draggable:!0,title:r.toString()});o.addLayer(a).addTo(n.map),a.on("drag",(function(t){n.markerDrag(o)})),a.on("dragend",(function(t){n.markerDragEnd(o)}))}))},i.prototype.createDivIcon=function(t){var o=t.join(" ");return e.divIcon({className:o})},i.prototype.markerDrag=function(t){var o=[],e=[],n=[],r=t.getLayers(),i=r[0].getLatLngs();console.log(i),console.log("markerdrag: ",r);var a=0;if(i.length>1)for(var s=0;s<i.length;s++)if(e=[],n=[],console.log("Posisjoner: ",i[s]),0===s){if(i[0].length>1)for(var l=0;s<i[0].length;l++){console.log("Posisjoner 2: ",i[s][l]);for(var u=0;u<i[0][l].length;u++)e.push(r[u+1].getLatLng());n.push(e)}else{for(u=0;u<i[0][0].length;u++)e.push(r[u+1].getLatLng());n.push(e)}console.log("Hole: ",n),o.push(n)}else{a+=i[s-1][0].length,console.log("STart index: ",a);for(u=a;u<i[s][0].length+a;u++)e.push(r[u+1].getLatLng());n.push(e),o.push(n)}else{n=[];var c=0;for(s=0;s<i[0].length;s++){if(e=[],console.log("Polygon drag: ",i[0][s]),0===s)if(i[0][s].length>1)for(u=0;u<i[0][s].length;u++)e.push(r[u+1].getLatLng());else for(u=0;u<i[0][0].length;u++)e.push(r[u+1].getLatLng());else for(u=c+=i[0][s-1].length;u<i[0][s].length+c;u++)e.push(r[u+1].getLatLng());n.push(e)}o.push(n),console.log("Hole 2: ",n)}console.log("Nye posisjoner: ",o),r[0].setLatLngs(o)},i.prototype.markerDragEnd=function(t){var o=this;this.polygonInformation.deletePolygonInformationStorage();var e=t.toGeoJSON();if(console.log("Markerdragend polygon: ",e.features[0].geometry.coordinates),e.features[0].geometry.coordinates.length>1)e.features[0].geometry.coordinates.forEach((function(e){var n=o.turfHelper.getMultiPolygon([e]);if(console.log("Markerdragend: ",n),o.turfHelper.hasKinks(n)){o.kinks=!0;var r=o.turfHelper.getKinks(n);o.removeFeatureGroup(t),console.log("Unkink: ",r),r.forEach((function(t){o.addPolygon(o.turfHelper.getTurfPolygon(t),!1,!0)}))}else o.kinks=!1,o.addPolygon(n,!1)}));else{var n=this.turfHelper.getMultiPolygon(e.features[0].geometry.coordinates);if(console.log("Markerdragend: ",n),this.turfHelper.hasKinks(n)){this.kinks=!0;var r=this.turfHelper.getKinks(n);this.removeFeatureGroup(t),console.log("Unkink: ",r),r.forEach((function(t){o.addPolygon(o.turfHelper.getTurfPolygon(t),!1,!0)}))}else this.kinks=!1,this.addPolygon(n,!1)}this.polygonInformation.createPolygonInformationStorage(this.arrayOfFeatureGroups)},i.prototype.getLatLngsFromJson=function(t){var o;return console.log("getLatLngsFromJson: ",t),t&&(o=t.geometry.coordinates.length>1&&"MultiPolygon"===t.geometry.type?e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0][0]):t.geometry.coordinates[0].length>1&&"Polygon"===t.geometry.type?e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0]):e.GeoJSON.coordsToLatLngs(t.geometry.coordinates[0][0])),o},i.prototype.unionPolygons=function(t,o,e){var n=this;console.log("unionPolygons",t,o,e);var r=o;t.forEach((function(t,o){var i=t.toGeoJSON().features[0],a=n.getLatLngsFromJson(i),s=n.turfHelper.union(r,e[o]);n.deletePolygonOnMerge(a),n.removeFeatureGroup(t),r=s}));var i=r;this.addPolygonLayer(i,!0)},i.prototype.removeFeatureGroup=function(t){console.log("removeFeatureGroup",t),t.clearLayers(),this.arrayOfFeatureGroups=this.arrayOfFeatureGroups.filter((function(o){return o!==t})),this.map.removeLayer(t)},i.prototype.removeFeatureGroupOnMerge=function(t){console.log("removeFeatureGroupOnMerge",t);var o=[];if(t.getLayers()[0]){var e=t.getLayers()[0].getLatLngs()[0];this.polygonInformation.polygonInformationStorage.forEach((function(t){t.polygon.toString()!==e[0].toString()&&t.polygon[0].toString()===e[0][0].toString()&&(t.polygon=e,o.push(t)),t.polygon.toString()!==e[0].toString()&&t.polygon[0].toString()!==e[0][0].toString()&&o.push(t)})),t.clearLayers(),this.arrayOfFeatureGroups=this.arrayOfFeatureGroups.filter((function(o){return o!==t})),this.map.removeLayer(t)}},i.prototype.deletePolygonOnMerge=function(t){var o=this;console.log("deletePolygonOnMerge",t);var e=[];this.arrayOfFeatureGroups.length>0&&this.arrayOfFeatureGroups.forEach((function(n){var r=n.getLayers()[0].getLatLngs()[0];e=g(r[0]),r[0][0]!==r[0][r[0].length-1]&&e.push(r[0][0]),o.polygonArrayEqualsMerge(e,t)&&(console.log("EQUALS",t),o.removeFeatureGroupOnMerge(n),o.deletePolygon(t),o.polygonInformation.deleteTrashcan(t))}))},i.prototype.polygonArrayEqualsMerge=function(t,o){return t.toString()===o.toString()},i.prototype.polygonArrayEquals=function(t,o){if(t[0][0]){if(!t[0][0].equals(o[0][0]))return!1}else if(!t[0].equals(o[0]))return!1;return t.length===o.length},i.prototype.setLeafletMapEvents=function(t,o,e){t?this.map.dragging.enable():this.map.dragging.disable(),o?this.map.doubleClickZoom.enable():this.map.doubleClickZoom.disable(),e?this.map.scrollWheelZoom.enable():this.map.scrollWheelZoom.disable()},i.prototype.setDrawMode=function(o){if(console.log("setDrawMode",this.map),this.drawModeSubject.next(o),this.map){var n=!0;switch(o){case t.DrawMode.Off:e.DomUtil.removeClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!1),this.stopDraw(),this.tracer.setStyle({color:""}),this.setLeafletMapEvents(!0,!0,!0),n=!1;break;case t.DrawMode.Add:e.DomUtil.addClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!0),this.tracer.setStyle({color:E.polyLineOptions.color}),this.setLeafletMapEvents(!1,!1,!1);break;case t.DrawMode.Subtract:e.DomUtil.addClass(this.map.getContainer(),"crosshair-cursor-enabled"),this.events(!0),this.tracer.setStyle({color:"#D9460F"}),this.setLeafletMapEvents(!1,!1,!1)}n?this.polygonInformation.setFreeDrawMode():this.polygonInformation.setMoveMode()}},i.prototype.modeChange=function(t){this.setDrawMode(t),this.polygonInformation.saveCurrentState()},i.prototype.drawModeClick=function(){this.polygonInformation.polygonDrawStates.isFreeDrawMode?(this.polygonInformation.setMoveMode(),this.setDrawMode(t.DrawMode.Off)):(this.polygonInformation.setFreeDrawMode(),this.setDrawMode(t.DrawMode.Add)),this.polygonInformation.saveCurrentState()},i.prototype.freedrawMenuClick=function(){this.setDrawMode(t.DrawMode.Add),this.polygonInformation.activate(),this.polygonInformation.saveCurrentState()},i.prototype.subtractClick=function(){this.setDrawMode(t.DrawMode.Subtract),this.polygonInformation.saveCurrentState()},i.prototype.resetTracker=function(){this.tracer.setLatLngs([[0,0]])},i.prototype.toggleMarkerMenu=function(){alert("open menu")},i.prototype.getHtmlContent=function(t){var o=this.popupGenerator.generateAlterPopup();return o.instance.bboxClicked.subscribe((function(o){console.log("bbox clicked",o),t(o)})),o.instance.simplyfiClicked.subscribe((function(o){console.log("simplyfi clicked",o),t(o)})),o.location.nativeElement},i.prototype.convertToBoundsPolygon=function(t,o){void 0===o&&(o=!1),this.deletePolygon([t]);var e=this.turfHelper.getMultiPolygon(this.convertToCoords([t])),n=this.turfHelper.convertToBoundingBoxPolygon(e,o);this.addPolygonLayer(this.turfHelper.getTurfPolygon(n),!1)},i.prototype.convertToSimplifiedPolygon=function(t){this.deletePolygon([t]);var o=this.turfHelper.getMultiPolygon(this.convertToCoords([t]));this.addPolygonLayer(this.turfHelper.getTurfPolygon(o),!0)},i.prototype.getMarkerIndex=function(t,o){var e=m.getBounds(t,Math.sqrt(2)/2),n=new v(e.getSouth(),e.getWest(),e.getNorth(),e.getEast()).getDirection(o),r={lat:n.lat,lng:n.lng},i=this.turfHelper.getCoord(r),a=this.turfHelper.getFeaturePointCollection(t);return this.turfHelper.getNearestPointIndex(i,a)},i.ctorParameters=function(){return[{type:f},{type:O},{type:S},{type:D},{type:j}]},i.ɵprov=o["ɵɵdefineInjectable"]({factory:function(){return new i(o["ɵɵinject"](f),o["ɵɵinject"](O),o["ɵɵinject"](S),o["ɵɵinject"](D),o["ɵɵinject"](j))},token:i,providedIn:"root"}),i=l([o.Injectable({providedIn:"root"}),u("design:paramtypes",[f,O,S,D,j])],i)}(),F=function(){function t(){}return t=l([o.NgModule({declarations:[C],imports:[],exports:[],entryComponents:[]})],t)}();t.AlterPolygonComponent=C,t.ComponentGeneraterService=O,t.MyLibModule=F,t.PolyDrawService=N,t.PolyStateService=f,t.PolygonDrawStates=L,t.PolygonInfo=M,t.PolygonInformationService=D,t.ɵ0=k,t.ɵ1=I,t.ɵa=S,t.ɵb=j,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=my-lib.umd.min.js.map